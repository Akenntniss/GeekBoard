---
description: 
globs: 
alwaysApply: false
---
# RÃ¨gles GeekBoard Multi-Database

## **ðŸ—„ï¸ Gestion des Connexions Database**

- **Toujours utiliser les fonctions de connexion appropriÃ©es**
  - `getShopDBConnection()` pour accÃ©der aux donnÃ©es du magasin actuel
  - `getMainDBConnection()` pour la configuration globale et la table `shops`
  - Ne jamais utiliser de connexions PDO directes ou `global $pdo`

- **VÃ©rification obligatoire du shop_id**
  ```php
  // âœ… CORRECT
  $shop_pdo = getShopDBConnection();
  if (!$shop_pdo) {
      error_log("Erreur connexion magasin");
      return false;
  }
  
  // âŒ INCORRECT
  global $pdo;
  $stmt = $pdo->prepare("SELECT...");
  ```

- **Structure de session requise**
  - Toujours vÃ©rifier `$_SESSION['shop_id']`
  - GÃ©rer le fallback si shop_id manquant
  - Logger les opÃ©rations avec le shop_id pour debug

## **ðŸ“ Structure des Fichiers**

- **Documentation technique**
  - CrÃ©er des guides dÃ©taillÃ©s avec exemples pratiques
  - Utiliser des Ã©mojis pour la lisibilitÃ© (ðŸ”§, ðŸ“Š, âœ…, âŒ)
  - Inclure des sections dÃ©pannage et bonnes pratiques
  - Fournir des scripts de diagnostic

- **Format des guides**
  ```markdown
  # ðŸŽ¯ TITRE PRINCIPAL
  ## Sous-section avec Context
  
  ### âœ… BONNE PRATIQUE
  ```php
  // Code correct avec commentaires
  ```
  
  ### âŒ MAUVAISE PRATIQUE
  ```php
  // Code Ã  Ã©viter avec explications
  ```
  ```

## **ðŸ” SÃ©curitÃ© et Isolation**

- **Isolation des donnÃ©es par magasin**
  - Chaque magasin doit accÃ©der uniquement Ã  sa propre base
  - Validation obligatoire du shop_id avant toute requÃªte
  - Logs dÃ©taillÃ©s pour tracer les accÃ¨s aux donnÃ©es

- **Gestion des erreurs**
  ```php
  // âœ… Gestion correcte
  try {
      $shop_pdo = getShopDBConnection();
      // ... opÃ©rations ...
  } catch (Exception $e) {
      error_log("Erreur shop_id " . ($_SESSION['shop_id'] ?? 'unknown') . ": " . $e->getMessage());
      // Fallback appropriÃ©
  }
  ```

## **ðŸŒ Gestion des Sous-domaines**

- **Configuration URL et routing**
  - Utiliser `subdomain_handler.php` pour router les sous-domaines
  - Stocker shop_id en session aprÃ¨s identification du sous-domaine
  - GÃ©rer les redirections avec paramÃ¨tres prÃ©servÃ©s

- **Exemple de configuration**
  ```php
  // URL: https://paris.mondomaine.com
  // â†’ $_SESSION['shop_id'] = 1 (Magasin Paris)
  // â†’ Connexion Ã  u139954273_paris database
  ```

## **ðŸ“‹ Migration et Maintenance**

- **Checklist de migration d'un fichier**
  1. Identifier tous les `$pdo` et `global $pdo`
  2. Remplacer par `$shop_pdo = getShopDBConnection()`
  3. Tester avec diffÃ©rents shop_id
  4. VÃ©rifier l'isolation des donnÃ©es
  5. Valider la gestion d'erreurs

- **Scripts de diagnostic Ã  crÃ©er**
  ```php
  // debug_shop_db.php - VÃ©rifier config magasin
  // session_debug.php - Analyser la session actuelle
  // connection_test.php - Tester les connexions
  ```

## **ðŸ“ Documentation et Communication**

- **RÃ©ponses en franÃ§ais**
  - Toujours rÃ©pondre en franÃ§ais comme spÃ©cifiÃ© dans les user_rules
  - Utiliser un langage technique prÃ©cis mais accessible
  - Fournir des exemples concrets et pratiques

- **Structure des explications**
  - Introduction avec contexte
  - Exemples pratiques avec code
  - Section dÃ©pannage
  - Conclusion avec points clÃ©s

## **ðŸš€ Bonnes Pratiques GÃ©nÃ©rales**

- **Logging et debug**
  ```php
  function dbDebugLog($message) {
      $timestamp = date('Y-m-d H:i:s');
      $shop_id = $_SESSION['shop_id'] ?? 'unknown';
      error_log("[{$timestamp}] [Shop:{$shop_id}] {$message}");
  }
  ```

- **Validation des donnÃ©es**
  - VÃ©rifier que la connexion retournÃ©e n'est pas null
  - Tester la validitÃ© de la connexion avant utilisation
  - ImplÃ©menter des fallbacks appropriÃ©s

- **Performance**
  - Utiliser le cache de connexion (`$shop_pdo` global)
  - Ã‰viter les reconnexions inutiles
  - Logger les temps de rÃ©ponse pour diagnostic

## **ðŸ” Patterns Ã  Surveiller**

- **Anti-patterns courants**
  ```php
  // âŒ Ã€ Ã©viter absolument
  global $pdo;
  require_once 'includes/db.php';
  $db = new PDO(...); // Connexion directe
  ```

- **Patterns corrects**
  ```php
  // âœ… Pattern recommandÃ©
  require_once 'config/database.php';
  $shop_pdo = getShopDBConnection();
  if ($shop_pdo) {
      $stmt = $shop_pdo->prepare("SELECT...");
      // ...
  }
  ```
