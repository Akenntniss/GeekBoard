---
description: Architecture multi-database et systÃ¨me de connexion GeekBoard
globs: **/*.php, config/**/*
alwaysApply: true
---

# **Architecture Multi-Database GeekBoard**

## **ğŸ—ï¸ Architecture GÃ©nÃ©rale**

- **Base Principale** : `geekboard_general`
  - Contient la table `shops` avec les mappings sous-domaines â†’ bases magasins
  - Point central de configuration pour tous les magasins

- **Bases Magasins** : Une base par magasin
  - Format : `geekboard_{nom_magasin}`
  - Exemples : `geekboard_mkmkmk`, `geekboard_cannesphones`
  - Isolation complÃ¨te des donnÃ©es entre magasins

## **ğŸ”Œ SystÃ¨me de Connexion Obligatoire**

### **âœ… TOUJOURS Utiliser :**
```php
// Connexion automatique basÃ©e sur le sous-domaine
$pdo = getShopDBConnection();

// Connexion par ID spÃ©cifique si nÃ©cessaire
$pdo = getShopDBConnectionById($shop_id);

// Initialisation de session pour APIs directes
initializeShopSession();
```

### **âŒ JAMAIS Utiliser :**
```php
// âŒ Connexions hardcodÃ©es interdites
$pdo = new PDO("mysql:host=localhost;dbname=geekboard_mkmkmk");
$pdo = new PDO("mysql:host=localhost;dbname=geekboard_cannesphones");

// âŒ Noms de bases en dur
$database = "geekboard_mkmkmk";
```

## **ğŸ¯ DÃ©tection Automatique**

### **Sous-domaines â†’ Bases de DonnÃ©es :**
- `mkmkmk.mdgeek.top` â†’ `geekboard_mkmkmk`
- `cannesphones.mdgeek.top` â†’ `geekboard_cannesphones`
- `{magasin}.mdgeek.top` â†’ `geekboard_{magasin}`

### **Session Management :**
- `$_SESSION['shop_id']` : ID du magasin actuel
- `detectShopFromSubdomain()` : DÃ©tection automatique
- Cache dans `$shop_pdo` global

## **ğŸ“‹ RÃ¨gles de DÃ©veloppement**

### **Pour les Pages Normales :**
- La dÃ©tection est automatique via l'initialisation de session
- Utiliser directement `getShopDBConnection()`

### **Pour les APIs Directes :**
```php
<?php
// Toujours inclure en dÃ©but d'API
require_once 'config/database.php';
initializeShopSession();

$pdo = getShopDBConnection();
// ... reste du code API
?>
```

### **Pour les Scripts d'Administration :**
```php
// Si besoin d'accÃ©der Ã  un magasin spÃ©cifique
$pdo = getShopDBConnectionById($specific_shop_id);
```

## **ğŸ”§ Fonctions Disponibles**

### **Dans `config/database.php` :**
- `getShopDBConnection()` : Connexion automatique basÃ©e sur session
- `getShopDBConnectionById($shop_id)` : Connexion par ID
- `initializeShopSession()` : Initialise la session magasin
- `detectShopFromSubdomain()` : DÃ©tecte le magasin depuis sous-domaine

## **âš ï¸ Points Critiques**

### **Isolation des DonnÃ©es :**
- Chaque magasin ne voit QUE ses donnÃ©es
- Aucun croisement possible entre magasins
- VÃ©rification automatique via sous-domaine

### **APIs et Endpoints :**
- Toujours appeler `initializeShopSession()` si accÃ¨s direct
- VÃ©rifier que `$_SESSION['shop_id']` est dÃ©fini
- Utiliser les fonctions de connexion standardisÃ©es

### **DÃ©bogage :**
```php
// Pour vÃ©rifier la connexion active
echo "Magasin actuel : " . $_SESSION['shop_id'] ?? 'Non dÃ©fini';
echo "Base de donnÃ©es : " . $pdo->query("SELECT DATABASE()")->fetchColumn();
```

---

**ğŸ¯ Objectif :** Maintenir une architecture multi-magasin robuste et sÃ©curisÃ©e avec isolation complÃ¨te des donnÃ©es.