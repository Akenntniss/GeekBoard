/* ====================================================================
   üé® MODAL FUTURISTE ULTRA-SIMPLE - SAISIE GARANTIE
   Version radicalement simplifi√©e qui fonctionne √† coup s√ªr
==================================================================== */

(function() {
    'use strict';
    
    console.log('üé® [FUTURISTE-ULTRA] Initialisation...');
    
    // Remplacer compl√®tement la fonction existante
    window.createNewClientModal = function() {
        console.log('üé® [FUTURISTE-ULTRA] Cr√©ation du modal ultra-simple...');
        
        // Supprimer tout modal existant
        const existing = document.querySelectorAll('#nouveauClientModal_temp, #modal-overlay-ultra, #futuristeUltraSimple');
        existing.forEach(el => el.remove());
        
        // Cr√©er le modal avec du HTML/CSS natif ultra-simple
        const modalContainer = document.createElement('div');
        modalContainer.id = 'futuristeUltraSimple';
        modalContainer.innerHTML = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 999999;
                display: flex;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(10px);
            " id="futuristeOverlay">
                <div style="
                    width: 500px;
                    max-width: 90%;
                    background: linear-gradient(145deg, #0f0f23 0%, #1a1a2e 100%);
                    border: 3px solid #00d4ff;
                    border-radius: 20px;
                    padding: 0;
                    box-shadow: 0 0 100px rgba(0, 212, 255, 0.8);
                    font-family: 'Orbitron', monospace;
                    color: white;
                " id="futuristeModal">
                    <!-- Header -->
                    <div style="
                        padding: 2rem;
                        text-align: center;
                        background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
                        border-bottom: 2px solid #00d4ff;
                        position: relative;
                    ">
                        <h2 style="
                            margin: 0;
                            font-size: 1.8rem;
                            color: #00d4ff;
                            text-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
                            font-weight: 700;
                        ">üë§ NOUVEAU CLIENT</h2>
                        <button onclick="closeFuturisteModal()" style="
                            position: absolute;
                            top: 1rem;
                            right: 1rem;
                            background: rgba(255, 0, 0, 0.3);
                            border: 2px solid #ff0040;
                            color: #ff0040;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 1.5rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                        ">‚úï</button>
                    </div>
                    
                    <!-- Body -->
                    <div style="padding: 2.5rem;">
                        <div style="margin-bottom: 2rem;">
                            <label style="
                                display: block;
                                margin-bottom: 0.8rem;
                                color: #00d4ff;
                                font-weight: 700;
                            ">üë§ NOM COMPLET *</label>
                            <input type="text" id="futuriste_nom" placeholder="Saisir le nom du client" style="
                                width: 100%;
                                padding: 1rem;
                                border: 3px solid #00d4ff;
                                border-radius: 15px;
                                font-size: 1.1rem;
                                background: rgba(0, 20, 40, 0.8);
                                color: white;
                                outline: none;
                                box-sizing: border-box;
                                font-family: inherit;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 2rem;">
                            <label style="
                                display: block;
                                margin-bottom: 0.8rem;
                                color: #00d4ff;
                                font-weight: 700;
                            ">üìû T√âL√âPHONE</label>
                            <input type="tel" id="futuriste_telephone" placeholder="Num√©ro de t√©l√©phone" style="
                                width: 100%;
                                padding: 1rem;
                                border: 3px solid #00d4ff;
                                border-radius: 15px;
                                font-size: 1.1rem;
                                background: rgba(0, 20, 40, 0.8);
                                color: white;
                                outline: none;
                                box-sizing: border-box;
                                font-family: inherit;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 2.5rem;">
                            <label style="
                                display: block;
                                margin-bottom: 0.8rem;
                                color: #00d4ff;
                                font-weight: 700;
                            ">‚úâÔ∏è EMAIL</label>
                            <input type="email" id="futuriste_email" placeholder="Adresse email" style="
                                width: 100%;
                                padding: 1rem;
                                border: 3px solid #00d4ff;
                                border-radius: 15px;
                                font-size: 1.1rem;
                                background: rgba(0, 20, 40, 0.8);
                                color: white;
                                outline: none;
                                box-sizing: border-box;
                                font-family: inherit;
                            ">
                        </div>
                        
                        <!-- Boutons -->
                        <div style="
                            display: flex;
                            gap: 1.5rem;
                            justify-content: center;
                        ">
                            <button onclick="closeFuturisteModal()" style="
                                background: rgba(255, 0, 0, 0.2);
                                border: 2px solid #ff0040;
                                color: #ff0040;
                                padding: 1rem 2rem;
                                border-radius: 15px;
                                cursor: pointer;
                                font-family: 'Orbitron', monospace;
                                font-weight: 700;
                            ">‚ùå ANNULER</button>
                            <button onclick="saveFuturisteClient()" style="
                                background: linear-gradient(135deg, #00d4ff 0%, #0080ff 100%);
                                border: 2px solid #00d4ff;
                                color: #000000;
                                padding: 1rem 2rem;
                                border-radius: 15px;
                                cursor: pointer;
                                font-family: 'Orbitron', monospace;
                                font-weight: 700;
                                box-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
                            ">üíæ ENREGISTRER</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Ajouter au DOM
        document.body.appendChild(modalContainer);
        
        // Activer les √©v√©nements de saisie EXPLICITES
        setTimeout(() => {
            const nomInput = document.getElementById('futuriste_nom');
            const telInput = document.getElementById('futuriste_telephone');
            const emailInput = document.getElementById('futuriste_email');
            
            [nomInput, telInput, emailInput].forEach(input => {
                if (input) {
                    // Forcer l'interactivit√©
                    input.style.pointerEvents = 'auto';
                    input.style.userSelect = 'text';
                    input.tabIndex = 1;
                    
                    // Gestionnaires d'√©v√©nements ULTRA-EXPLICITES
                    input.addEventListener('keydown', function(e) {
                        console.log('‚å®Ô∏è [FUTURISTE-ULTRA] Keydown sur', input.id, ':', e.key);
                        e.stopPropagation(); // Emp√™cher l'interf√©rence
                        return true; // Permettre la saisie
                    }, true);
                    
                    input.addEventListener('keypress', function(e) {
                        console.log('üìù [FUTURISTE-ULTRA] Keypress sur', input.id, ':', e.key);
                        e.stopPropagation();
                        return true;
                    }, true);
                    
                    input.addEventListener('input', function(e) {
                        console.log('‚úèÔ∏è [FUTURISTE-ULTRA] Input sur', input.id, ':', this.value);
                        e.stopPropagation();
                        return true;
                    }, true);
                    
                    input.addEventListener('focus', function(e) {
                        console.log('üéØ [FUTURISTE-ULTRA] Focus sur', input.id);
                        this.style.borderColor = '#00ffff';
                        this.style.boxShadow = '0 0 20px rgba(0, 255, 255, 0.8)';
                    });
                    
                    input.addEventListener('blur', function(e) {
                        console.log('üëÅÔ∏è [FUTURISTE-ULTRA] Blur sur', input.id);
                        this.style.borderColor = '#00d4ff';
                        this.style.boxShadow = 'none';
                    });
                    
                    // Test de saisie manuelle
                    input.addEventListener('click', function(e) {
                        console.log('üëÜ [FUTURISTE-ULTRA] Clic sur', input.id);
                        this.focus();
                        // Tester la saisie imm√©diatement
                        setTimeout(() => {
                            console.log('üß™ [FUTURISTE-ULTRA] Test de saisie apr√®s clic');
                            const originalValue = this.value;
                            this.value = originalValue + 'üß™';
                            setTimeout(() => {
                                this.value = originalValue;
                                console.log('‚úÖ [FUTURISTE-ULTRA] Le champ', input.id, 'accepte la modification programmatique');
                            }, 100);
                        }, 50);
                    });
                    
                    console.log('‚úÖ [FUTURISTE-ULTRA] √âv√©nements activ√©s pour', input.id);
                }
            });
            
            // Focus sur le nom
            if (nomInput) {
                nomInput.focus();
                console.log('üéØ [FUTURISTE-ULTRA] Focus sur le nom');
                
                // Test final de saisie
                setTimeout(() => {
                    nomInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'T', bubbles: true }));
                    console.log('üß™ [FUTURISTE-ULTRA] Test d\'√©v√©nement clavier envoy√©');
                }, 200);
            }
        }, 100);
        
        console.log('‚úÖ [FUTURISTE-ULTRA] Modal cr√©√© et pr√™t');
    };
    
    // Fonction de fermeture
    window.closeFuturisteModal = function() {
        console.log('üîí [FUTURISTE-ULTRA] Fermeture du modal');
        const modal = document.getElementById('futuristeUltraSimple');
        if (modal) {
            modal.remove();
        }
    };
    
    // Fonction de sauvegarde
    window.saveFuturisteClient = function() {
        console.log('üíæ [FUTURISTE-ULTRA] Sauvegarde du client');
        
        const nom = document.getElementById('futuriste_nom')?.value?.trim() || '';
        const telephone = document.getElementById('futuriste_telephone')?.value?.trim() || '';
        const email = document.getElementById('futuriste_email')?.value?.trim() || '';
        
        if (!nom) {
            alert('Le nom est obligatoire !');
            document.getElementById('futuriste_nom')?.focus();
            return;
        }
        
        console.log('üìù Client cr√©√©:', { nom, telephone, email });
        
        // Mettre √† jour le modal de commande
        const clientSearchInput = document.getElementById('nom_client_selectionne');
        const clientIdInput = document.getElementById('client_id');
        
        if (clientSearchInput) {
            clientSearchInput.value = nom;
            console.log('‚úÖ Client search input mis √† jour');
        }
        if (clientIdInput) {
            clientIdInput.value = 'new_' + Date.now();
            console.log('‚úÖ Client ID mis √† jour');
        }
        
        // Message de succ√®s
        alert(`‚úÖ Client "${nom}" cr√©√© avec succ√®s !`);
        
        // Fermer le modal
        closeFuturisteModal();
    };
    
    // Fonction de test
    window.testFuturisteUltra = function() {
        console.log('üß™ [FUTURISTE-ULTRA] Test du modal');
        
        createNewClientModal();
        
        setTimeout(() => {
            const nomInput = document.getElementById('futuriste_nom');
            if (nomInput) {
                nomInput.value = 'Test Client Futuriste';
                nomInput.focus();
                console.log('‚úÖ Test effectu√© - essayez de taper maintenant !');
            }
        }, 200);
    };
    
    // Fonction de diagnostic avanc√©e
    window.diagnoseFuturisteInput = function() {
        console.log('üîç [FUTURISTE-ULTRA] === DIAGNOSTIC COMPLET ===');
        
        const nomInput = document.getElementById('futuriste_nom');
        if (!nomInput) {
            console.log('‚ùå Champ nom non trouv√©');
            return;
        }
        
        console.log('‚úÖ Champ nom trouv√©:', nomInput);
        console.log('üìä Propri√©t√©s du champ:');
        console.log('  - disabled:', nomInput.disabled);
        console.log('  - readOnly:', nomInput.readOnly);
        console.log('  - tabIndex:', nomInput.tabIndex);
        console.log('  - style.pointerEvents:', nomInput.style.pointerEvents);
        console.log('  - style.userSelect:', nomInput.style.userSelect);
        console.log('  - contentEditable:', nomInput.contentEditable);
        
        // Test des √©v√©nements
        console.log('üß™ Test des √©v√©nements:');
        
        // Simuler diff√©rents types d'√©v√©nements
        try {
            console.log('  1. Test KeyboardEvent...');
            const keyEvent = new KeyboardEvent('keydown', { 
                key: 'A', 
                code: 'KeyA', 
                bubbles: true, 
                cancelable: true 
            });
            const keyResult = nomInput.dispatchEvent(keyEvent);
            console.log('     R√©sultat KeyboardEvent:', keyResult);
        } catch (e) {
            console.log('     ‚ùå Erreur KeyboardEvent:', e.message);
        }
        
        try {
            console.log('  2. Test InputEvent...');
            const inputEvent = new InputEvent('input', { 
                data: 'A', 
                bubbles: true, 
                cancelable: true 
            });
            const inputResult = nomInput.dispatchEvent(inputEvent);
            console.log('     R√©sultat InputEvent:', inputResult);
        } catch (e) {
            console.log('     ‚ùå Erreur InputEvent:', e.message);
        }
        
        // Test de focus
        console.log('  3. Test focus...');
        nomInput.focus();
        console.log('     Document.activeElement === nomInput:', document.activeElement === nomInput);
        
        // Test de modification directe
        console.log('  4. Test modification directe...');
        const originalValue = nomInput.value;
        nomInput.value = 'TEST DIAGNOSTIC';
        console.log('     Valeur apr√®s modification:', nomInput.value);
        setTimeout(() => {
            nomInput.value = originalValue;
            console.log('     Valeur restaur√©e:', nomInput.value);
        }, 1000);
        
        // V√©rifier les event listeners
        console.log('üéØ V√©rification des event listeners...');
        const listeners = getEventListeners ? getEventListeners(nomInput) : 'Non disponible en mode non-dev';
        console.log('  Event listeners d√©tect√©s:', listeners);
        
        console.log('üîç === FIN DU DIAGNOSTIC ===');
        console.log('üí° Maintenant, cliquez sur le champ nom et essayez de taper...');
    };
    
    console.log('üöÄ [FUTURISTE-ULTRA] Script charg√©');
    console.log('üí° Utilisez window.testFuturisteUltra() pour tester');
    
})();
