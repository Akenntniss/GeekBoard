# Activation du module de réécriture
RewriteEngine On

# Définir la base du répertoire pour les règles de réécriture
RewriteBase /

# Permettre l'accès direct aux scripts de test et de débogage
RewriteRule ^subdomain_test\.php$ - [L]

# Règle spéciale pour les devis publics - DOIT ÊTRE AVANT les règles de sous-domaines
# Rediriger devis/[hash] vers devis_public.php?lien=[hash] sans authentification
RewriteRule ^devis/([a-f0-9]{32})/?$ /devis_public.php?lien=$1 [L,QSA]

# NOUVELLES RÈGLES POUR L'INTERNATIONALISATION - URLs avec préfixes de langue
RewriteCond %{HTTP_HOST} ^(www\.)?(mdgeek\.top|servo\.tools)$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(en|es|de|it)/?$ /marketing/router.php [QSA,L]

RewriteCond %{HTTP_HOST} ^(www\.)?(mdgeek\.top|servo\.tools)$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(en|es|de|it)/(.*)$ /marketing/router.php [QSA,L]

# Version simplifiée pour la détection des sous-domaines
# Capturer le sous-domaine dans une variable SUBDOMAIN (hors domaine racine)
RewriteCond %{HTTP_HOST} ^([^.]+)\.mdgeek\.top$ [NC]
RewriteRule ^ - [E=SUBDOMAIN:%1]

# Debug - Ajouter le sous-domaine aux en-têtes HTTP
RewriteCond %{ENV:SUBDOMAIN} !^$
RewriteRule ^ - [E=HTTP_X_SUBDOMAIN:%{ENV:SUBDOMAIN}]

# Règle pour supprimer l'extension .php des URLs - DOIT ÊTRE AVANT les règles marketing
RewriteCond %{HTTP_HOST} ^(www\.)?(mdgeek\.top|servo\.tools)$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*)$ $1.php [L]

# Site marketing pour domaines racine mdgeek.top et servo.tools
# Ne pas intercepter les requêtes API/app existantes
RewriteCond %{HTTP_HOST} ^(www\.)?(mdgeek\.top|servo\.tools)$ [NC]
RewriteCond %{REQUEST_URI} !^/(public|assets|contact_handler\.php|superadmin|api|ajax|pages|includes|config|actions|classes|download|export|scripts|temp|tmp)/ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(features|fonctionnalites|pricing|tarifs|testimonials|temoignages|contact|demo|roi|calculator|calculateur|integrations|multistore|security|customer-portal|vs-repairdesk|cgv|conditions-generales-vente|cgu|conditions-generales-utilisation|terms|privacy|confidentialite|politique-confidentialite|mentions-legales|legal)$ /marketing/router.php [L]

# Redirection du domaine principal vers marketing
RewriteCond %{HTTP_HOST} ^(www\.)?(mdgeek\.top|servo\.tools)$ [NC]
RewriteCond %{REQUEST_URI} ^/$ [NC]
RewriteRule ^$ /marketing/router.php [QSA,L]

# Règle principale pour rediriger vers le gestionnaire de sous-domaines
RewriteCond %{ENV:SUBDOMAIN} !^$
RewriteCond %{HTTP_HOST} !^(www\.)?mdgeek\.top$ [NC]
RewriteCond %{REQUEST_URI} !^/subdomain_handler\.php
RewriteCond %{REQUEST_URI} !^/devis/
RewriteRule ^(.*)$ /subdomain_handler.php?subdomain=%{ENV:SUBDOMAIN}&path=$1 [QSA,L]

# Redirection pour éviter l'accès direct aux fichiers .php (optionnel)
# RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/+(.+)\.php[\s?] [NC]
# RewriteRule ^ /%1 [R=301,L]

# Ne pas appliquer les règles aux fichiers existants, répertoires ou liens symboliques
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d [OR]
RewriteCond %{REQUEST_FILENAME} -l
RewriteRule ^ - [L]

# Règles PHP pour améliorer la sécurité
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log /path/to/error.log
    php_value max_execution_time 60
    php_value memory_limit 256M
    php_value post_max_size 64M
    php_value upload_max_filesize 32M
</IfModule>

# Protection des répertoires sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Compression Gzip
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/x-javascript application/json
</IfModule>

# Mise en cache des fichiers statiques
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType text/html "access plus 1 day"
</IfModule>
