# üóÑÔ∏è GUIDE COMPLET - GESTION MULTI-DATABASE GEEKBOARD
## Interface Multi-Magasins avec Bases de Donn√©es S√©par√©es

---

## üìã INTRODUCTION

GeekBoard utilise un syst√®me de **bases de donn√©es multiples** pour permettre √† plusieurs magasins d'utiliser la m√™me interface tout en gardant leurs donn√©es **compl√®tement s√©par√©es et s√©curis√©es**. Chaque magasin dispose de sa propre base de donn√©es.

### üéØ ARCHITECTURE G√âN√âRALE

```
üè™ MAGASIN A (shop_id: 1)  ‚Üí  üìä DATABASE_A (u139954273_shop1)
üè™ MAGASIN B (shop_id: 2)  ‚Üí  üìä DATABASE_B (u139954273_shop2)  
üè™ MAGASIN C (shop_id: 3)  ‚Üí  üìä DATABASE_C (u139954273_shop3)
                               
üìä BASE PRINCIPALE         ‚Üí  üìä DATABASE_MAIN (u139954273_Vscodetest)
   (Configuration Magasins)    (Infos de connexion pour chaque magasin)
```

---

## üîß CONFIGURATION DES CONNEXIONS

### 1. üìÅ **Fichier Principal : `config/database.php`**

Ce fichier g√®re **toutes les connexions** aux diff√©rentes bases de donn√©es.

#### **Variables Globales**
```php
$main_pdo = null;   // Connexion √† la base principale (configuration)
$shop_pdo = null;   // Connexion √† la base du magasin actuel
```

#### **Configuration Base Principale**
```php
define('MAIN_DB_HOST', '191.96.63.103');
define('MAIN_DB_PORT', '3306');
define('MAIN_DB_USER', 'u139954273_Vscodetest');
define('MAIN_DB_PASS', 'Maman01#');
define('MAIN_DB_NAME', 'u139954273_Vscodetest');
```

### 2. üè¢ **Table `shops` dans la Base Principale**

La base principale contient une table `shops` avec les informations de connexion pour chaque magasin :

```sql
CREATE TABLE shops (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nom VARCHAR(255) NOT NULL,
    subdomain VARCHAR(100) UNIQUE,
    db_host VARCHAR(255),
    db_port INT DEFAULT 3306,
    db_user VARCHAR(255),
    db_pass VARCHAR(255),
    db_name VARCHAR(255),
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **Exemple de Donn√©es**
```sql
INSERT INTO shops VALUES 
(1, 'Magasin Paris', 'paris', '191.96.63.103', 3306, 'u139954273_paris', 'MotDePasse1', 'u139954273_paris', 1),
(2, 'Magasin Lyon', 'lyon', '191.96.63.103', 3306, 'u139954273_lyon', 'MotDePasse2', 'u139954273_lyon', 1),
(3, 'Magasin Nice', 'nice', '191.96.63.103', 3306, 'u139954273_nice', 'MotDePasse3', 'u139954273_nice', 1);
```

---

## üîå FONCTIONS DE CONNEXION

### 1. üìä **getMainDBConnection()** - Base Principale

```php
function getMainDBConnection() {
    global $main_pdo;
    
    // Connexion √† la base principale (configuration des magasins)
    if ($main_pdo === null) {
        $dsn = "mysql:host=" . MAIN_DB_HOST . ";port=" . MAIN_DB_PORT . 
               ";dbname=" . MAIN_DB_NAME . ";charset=utf8mb4";
        
        $main_pdo = new PDO($dsn, MAIN_DB_USER, MAIN_DB_PASS, [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]);
    }
    
    return $main_pdo;
}
```

### 2. üè™ **getShopDBConnection()** - Base du Magasin Actuel

```php
function getShopDBConnection() {
    global $shop_pdo;
    
    // R√©cup√©ration du shop_id depuis la session ou l'URL
    $shop_id = $_SESSION['shop_id'] ?? $_GET['shop_id'] ?? null;
    
    if (!$shop_id) {
        error_log("ERREUR: Aucun shop_id d√©fini");
        return getMainDBConnection(); // Fallback vers base principale
    }
    
    // Cache la connexion pour √©viter de se reconnecter
    if ($shop_pdo !== null) {
        return $shop_pdo;
    }
    
    // R√©cup√©ration des infos de connexion depuis la base principale
    $main_pdo = getMainDBConnection();
    $stmt = $main_pdo->prepare("SELECT * FROM shops WHERE id = ?");
    $stmt->execute([$shop_id]);
    $shop = $stmt->fetch();
    
    if ($shop) {
        // Connexion √† la base du magasin sp√©cifique
        $shop_config = [
            'host' => $shop['db_host'],
            'port' => $shop['db_port'] ?? 3306,
            'user' => $shop['db_user'],
            'pass' => $shop['db_pass'],
            'dbname' => $shop['db_name']
        ];
        
        $shop_pdo = connectToShopDB($shop_config);
    }
    
    return $shop_pdo ?? getMainDBConnection(); // Fallback si √©chec
}
```

### 3. üîó **connectToShopDB()** - Connexion Dynamique

```php
function connectToShopDB($shop_config) {
    $dsn = "mysql:host=" . $shop_config['host'] . 
           ";port=" . $shop_config['port'] . 
           ";dbname=" . $shop_config['dbname'] . 
           ";charset=utf8mb4";
    
    try {
        $pdo = new PDO($dsn, $shop_config['user'], $shop_config['pass'], [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]);
        
        return $pdo;
    } catch (PDOException $e) {
        error_log("Erreur connexion magasin: " . $e->getMessage());
        return null;
    }
}
```

---

## üåê GESTION DES SOUS-DOMAINES

### üìÅ **Fichier : `subdomain_handler.php`**

Ce fichier g√®re l'acc√®s aux magasins via des sous-domaines.

```php
// Exemple d'URLs :
// https://paris.mondomaine.com    ‚Üí Magasin Paris (shop_id = 1)
// https://lyon.mondomaine.com     ‚Üí Magasin Lyon (shop_id = 2)
// https://nice.mondomaine.com     ‚Üí Magasin Nice (shop_id = 3)

// R√©cup√©ration du sous-domaine
$subdomain = $_GET['subdomain'] ?? '';

// Recherche du magasin correspondant
$stmt = $main_pdo->prepare("SELECT * FROM shops WHERE subdomain = ? AND active = 1");
$stmt->execute([$subdomain]);
$shop = $stmt->fetch();

if ($shop) {
    // Stockage de l'ID du magasin en session
    $_SESSION['shop_id'] = $shop['id'];
    $_SESSION['shop_name'] = $shop['nom'];
    
    // Redirection vers l'interface du magasin
    header('Location: /index.php');
} else {
    // Magasin non trouv√©
    include 'templates/shop_not_found.php';
}
```

---

## üíª UTILISATION DANS LE CODE

### ‚úÖ **BONNE PRATIQUE - Utilisation Correcte**

```php
<?php
// 1. Inclusion de la configuration
require_once 'config/database.php';

// 2. R√©cup√©ration de la connexion du magasin actuel
$shop_pdo = getShopDBConnection();

// 3. Utilisation pour les requ√™tes
$stmt = $shop_pdo->prepare("SELECT * FROM clients WHERE id = ?");
$stmt->execute([$client_id]);
$client = $stmt->fetch();

// 4. Exemple pour les r√©parations
$stmt = $shop_pdo->prepare("SELECT r.*, c.nom FROM reparations r 
                           JOIN clients c ON r.client_id = c.id 
                           WHERE r.status = ?");
$stmt->execute(['en_cours']);
$reparations = $stmt->fetchAll();
?>
```

### ‚ùå **MAUVAISE PRATIQUE - √Ä √âviter**

```php
<?php
// ‚ùå NE PAS FAIRE - Utilise la connexion principale au lieu du magasin
global $pdo;
$stmt = $pdo->prepare("SELECT * FROM clients WHERE id = ?");

// ‚ùå NE PAS FAIRE - Connexion directe sans passer par les fonctions
$pdo = new PDO("mysql:host=...", $user, $pass);
?>
```

---

## üîê S√âCURIT√â ET ISOLATION

### üõ°Ô∏è **Avantages du Syst√®me Multi-Database**

1. **üîí ISOLATION COMPL√àTE**
   - Chaque magasin ne peut acc√©der qu'√† ses propres donn√©es
   - Impossible d'acc√©der aux donn√©es d'un autre magasin par erreur

2. **üîê S√âCURIT√â RENFORC√âE**
   - Chaque magasin a ses propres identifiants de base de donn√©es
   - En cas de compromission, seul un magasin est affect√©

3. **üìä PERFORMANCE**
   - Les requ√™tes sont plus rapides (moins de donn√©es par base)
   - Possibilit√© de distribuer les bases sur diff√©rents serveurs

4. **üîß MAINTENANCE FACILIT√âE**
   - Sauvegarde/restauration par magasin
   - Mise √† jour individuelle possible

---

## üö® D√âPANNAGE COURANT

### 1. üìã **V√©rifier la Configuration d'un Magasin**

```php
// Script de diagnostic : debug_shop_db.php
$shop_id = $_GET['shop_id'] ?? 1;
$main_pdo = getMainDBConnection();

$stmt = $main_pdo->prepare("SELECT * FROM shops WHERE id = ?");
$stmt->execute([$shop_id]);
$shop = $stmt->fetch();

echo "<h2>Configuration Magasin #$shop_id</h2>";
print_r($shop);

// Test de connexion
$shop_pdo = getShopDBConnection();
if ($shop_pdo) {
    echo "<p>‚úÖ Connexion r√©ussie</p>";
    
    // V√©rifier quelle base est utilis√©e
    $stmt = $shop_pdo->query("SELECT DATABASE() as db_name");
    $result = $stmt->fetch();
    echo "<p>Base connect√©e: " . $result['db_name'] . "</p>";
} else {
    echo "<p>‚ùå √âchec de connexion</p>";
}
```

### 2. üîç **V√©rifier la Session Actuelle**

```php
// Affichage des informations de session
echo "<h3>Session Actuelle</h3>";
echo "Shop ID: " . ($_SESSION['shop_id'] ?? 'Non d√©fini') . "<br>";
echo "Shop Name: " . ($_SESSION['shop_name'] ?? 'Non d√©fini') . "<br>";
echo "URL Shop ID: " . ($_GET['shop_id'] ?? 'Non d√©fini') . "<br>";
```

### 3. üîß **Probl√®mes Fr√©quents**

#### **Probl√®me 1: Shop_id non d√©fini**
```php
// Solution : Forcer un shop_id par d√©faut
if (!isset($_SESSION['shop_id'])) {
    $_SESSION['shop_id'] = 1; // Magasin par d√©faut
    error_log("Shop_id manquant, utilisation du magasin par d√©faut");
}
```

#### **Probl√®me 2: Connexion √† la mauvaise base**
```php
// V√©rification et correction
$shop_pdo = getShopDBConnection();
$stmt = $shop_pdo->query("SELECT DATABASE() as current_db");
$result = $stmt->fetch();

if ($result['current_db'] != $expected_db_name) {
    error_log("ERREUR: Connexion √† " . $result['current_db'] . 
              " au lieu de " . $expected_db_name);
    // Forcer la reconnexion
    $shop_pdo = null;
    $shop_pdo = getShopDBConnection();
}
```

---

## üìö EXEMPLES PRATIQUES

### 1. üè™ **Page de Gestion des Clients**

```php
<?php
// pages/clients.php
require_once '../config/database.php';

// Connexion au magasin actuel
$shop_pdo = getShopDBConnection();

// R√©cup√©ration des clients du magasin actuel UNIQUEMENT
$stmt = $shop_pdo->prepare("
    SELECT c.*, COUNT(r.id) as nb_reparations 
    FROM clients c 
    LEFT JOIN reparations r ON c.id = r.client_id 
    GROUP BY c.id 
    ORDER BY c.nom
");
$stmt->execute();
$clients = $stmt->fetchAll();

// Affichage
foreach ($clients as $client) {
    echo "<div class='client'>";
    echo "<h3>" . htmlspecialchars($client['nom']) . "</h3>";
    echo "<p>R√©parations: " . $client['nb_reparations'] . "</p>";
    echo "</div>";
}
?>
```

### 2. üìä **Dashboard avec Statistiques**

```php
<?php
// pages/dashboard.php
require_once '../config/database.php';

$shop_pdo = getShopDBConnection();

// Statistiques du magasin actuel uniquement
$stats = [];

// Nombre total de r√©parations
$stmt = $shop_pdo->query("SELECT COUNT(*) as total FROM reparations");
$stats['total_reparations'] = $stmt->fetch()['total'];

// R√©parations en cours
$stmt = $shop_pdo->query("SELECT COUNT(*) as total FROM reparations WHERE status = 'en_cours'");
$stats['reparations_en_cours'] = $stmt->fetch()['total'];

// Chiffre d'affaires du mois
$stmt = $shop_pdo->query("SELECT SUM(prix) as total FROM reparations 
                         WHERE DATE_FORMAT(date_creation, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
                         AND status = 'terminee'");
$stats['ca_mois'] = $stmt->fetch()['total'] ?? 0;

echo "<h2>Statistiques - " . ($_SESSION['shop_name'] ?? 'Magasin') . "</h2>";
echo "<div class='stats'>";
echo "<div>Total r√©parations: " . $stats['total_reparations'] . "</div>";
echo "<div>En cours: " . $stats['reparations_en_cours'] . "</div>";
echo "<div>CA ce mois: " . number_format($stats['ca_mois'], 2) . " ‚Ç¨</div>";
echo "</div>";
?>
```

### 3. üîÑ **Migration de Code Existant**

```php
// AVANT (code obsol√®te utilisant la base principale)
<?php
global $pdo;
$stmt = $pdo->prepare("SELECT * FROM clients WHERE id = ?");
$stmt->execute([$client_id]);
$client = $stmt->fetch();
?>

// APR√àS (code correct utilisant la base du magasin)
<?php
$shop_pdo = getShopDBConnection();
$stmt = $shop_pdo->prepare("SELECT * FROM clients WHERE id = ?");
$stmt->execute([$client_id]);
$client = $stmt->fetch();
?>
```

---

## üéØ CONFIGURATION APACHE/NGINX

### üåê **Configuration des Sous-domaines**

#### **Apache (.htaccess)**
```apache
RewriteEngine On

# Redirection des sous-domaines vers subdomain_handler.php
RewriteCond %{HTTP_HOST} ^([^.]+)\.mondomaine\.com$ [NC]
RewriteRule ^(.*)$ /subdomain_handler.php?subdomain=%1&path=$1 [QSA,L]

# Gestion du domaine principal
RewriteCond %{HTTP_HOST} ^mondomaine\.com$ [NC]
RewriteRule ^(.*)$ /index.php [QSA,L]
```

#### **Nginx**
```nginx
server {
    listen 80;
    server_name *.mondomaine.com;
    
    location / {
        if ($host ~* ^([^.]+)\.mondomaine\.com$) {
            set $subdomain $1;
            rewrite ^/(.*)$ /subdomain_handler.php?subdomain=$subdomain&path=$1 last;
        }
    }
}
```

---

## üìã CHECKLIST DE MIGRATION

### ‚úÖ **Avant de Migrer un Fichier**

1. **üîç Identifier** toutes les utilisations de `$pdo` ou `global $pdo`
2. **üîÑ Remplacer** par `$shop_pdo = getShopDBConnection();`
3. **üß™ Tester** avec diff√©rents shop_id
4. **üìù V√©rifier** que les donn√©es affich√©es correspondent au bon magasin
5. **üö® Valider** que les erreurs sont g√©r√©es correctement

### üîß **Script de Recherche des Fichiers √† Migrer**

```bash
# Rechercher tous les fichiers utilisant encore $pdo
grep -r "global \$pdo" public_html/pages/
grep -r "\$pdo->" public_html/pages/
grep -r "\$pdo=" public_html/pages/

# Rechercher les inclusions de l'ancien db.php
grep -r "includes/db.php" public_html/
```

---

## üöÄ BONNES PRATIQUES

### 1. **üéØ Toujours Utiliser les Fonctions**
- ‚úÖ `getShopDBConnection()` pour les donn√©es du magasin
- ‚úÖ `getMainDBConnection()` pour la configuration globale

### 2. **üîê V√©rifier le Shop_ID**
```php
if (!isset($_SESSION['shop_id'])) {
    header('Location: /login.php');
    exit;
}
```

### 3. **üìù Logger les Op√©rations**
```php
function dbDebugLog($message) {
    $timestamp = date('Y-m-d H:i:s');
    $shop_id = $_SESSION['shop_id'] ?? 'unknown';
    error_log("[{$timestamp}] [Shop:{$shop_id}] {$message}");
}
```

### 4. **üîÑ Gestion des Erreurs**
```php
$shop_pdo = getShopDBConnection();
if (!$shop_pdo) {
    error_log("Erreur: Impossible de se connecter √† la base du magasin");
    include 'templates/error_db.php';
    exit;
}
```

---

## üéâ CONCLUSION

Ce syst√®me multi-database permet √† GeekBoard de g√©rer plusieurs magasins de mani√®re **s√©curis√©e**, **performante** et **isol√©e**. Chaque magasin dispose de sa propre base de donn√©es tout en partageant la m√™me interface.

### üìû **Support et Aide**

Pour toute question ou probl√®me :
1. V√©rifiez les logs dans `/logs/`
2. Utilisez les scripts de diagnostic fournis
3. Consultez ce guide pour les bonnes pratiques

**L'architecture multi-database de GeekBoard garantit une s√©paration compl√®te des donn√©es entre magasins tout en maintenant une interface unifi√©e et intuitive.** 