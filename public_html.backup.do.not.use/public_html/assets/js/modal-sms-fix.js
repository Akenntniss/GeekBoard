/**
 * Script de correction sp√©cifique pour le modal SMS
 * Force l'affichage correct et corrige les probl√®mes de backdrop
 */

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ [SMS-MODAL-FIX] ‚ö†Ô∏è Script SMS d√©sactiv√© pour √©viter l\'ouverture automatique');
    
    // D√âSACTIV√â : Ce script causait l'ouverture automatique du modal SMS
    // setTimeout(function() {
    //     initSmsModalFix();
    // }, 1000);
});

function initSmsModalFix() {
    console.log('üîÑ [SMS-MODAL-FIX] üöÄ Initialisation des corrections SMS...');
    
    // Observer pour d√©tecter la cr√©ation du modal SMS
    const smsModalObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && node.id === 'smsModal') {
                    console.log('üîÑ [SMS-MODAL-FIX] üì± Modal SMS d√©tect√©, application des corrections...');
                    applySmsModalFixes(node);
                }
            });
        });
    });
    
    smsModalObserver.observe(document.body, { childList: true, subtree: true });
    
    // V√©rifier si le modal existe d√©j√†
    const existingSmsModal = document.getElementById('smsModal');
    if (existingSmsModal) {
        console.log('üîÑ [SMS-MODAL-FIX] üì± Modal SMS existant trouv√©');
        applySmsModalFixes(existingSmsModal);
    }
    
    // Intercepter la fonction openSmsModal si elle existe
    if (window.openSmsModal && typeof window.openSmsModal === 'function') {
        const originalOpenSms = window.openSmsModal;
        window.openSmsModal = function() {
            console.log('üîÑ [SMS-MODAL-FIX] üéØ Interception openSmsModal');
            
            // Appliquer les corrections avant l'ouverture
            setTimeout(function() {
                const smsModal = document.getElementById('smsModal');
                if (smsModal) {
                    applySmsModalFixes(smsModal);
                    forceSmsModalDisplay(smsModal);
                }
            }, 100);
            
            // D√âSACTIV√â : V√©rification qui causait l'ouverture automatique
            // setTimeout(function() {
            //     const smsModal = document.getElementById('smsModal');
            //     if (smsModal && smsModal.classList.contains('show')) {
            //         const rect = smsModal.getBoundingClientRect();
            //         if (rect.width === 0 || rect.height === 0) {
            //             console.log('üîÑ [SMS-MODAL-FIX] üö® Modal original d√©faillant, activation du modal de secours automatique...');
            //             window.createEmergencySmsModal();
            //         }
            //     } else {
            //         console.log('üîÑ [SMS-MODAL-FIX] üö® Modal SMS ne s\'est pas ouvert, activation du modal de secours...');
            //         window.createEmergencySmsModal();
            //     }
            // }, 1500);
            
            return originalOpenSms.apply(this, arguments);
        };
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Intercepteur openSmsModal install√©');
    }
}

function applySmsModalFixes(smsModal) {
    console.log('üîÑ [SMS-MODAL-FIX] üîß Application des corrections au modal SMS...');
    
    // Ajouter la classe de correction
    smsModal.classList.add('modal-over-repair');
    
    // √âcouter les √©v√©nements du modal
    smsModal.addEventListener('show.bs.modal', function() {
        console.log('üîÑ [SMS-MODAL-FIX] üì± Modal SMS en cours d\'ouverture');
        setTimeout(function() {
            forceSmsModalDisplay(smsModal);
        }, 50);
    });
    
    smsModal.addEventListener('shown.bs.modal', function() {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Modal SMS ouvert avec succ√®s');
        forceSmsModalDisplay(smsModal);
    });
    
    smsModal.addEventListener('hide.bs.modal', function() {
        console.log('üîÑ [SMS-MODAL-FIX] üì± Modal SMS en cours de fermeture');
    });
    
    smsModal.addEventListener('hidden.bs.modal', function() {
        console.log('üîÑ [SMS-MODAL-FIX] üì± Modal SMS ferm√©');
    });
}

function forceSmsModalDisplay(smsModal) {
    console.log('üîÑ [SMS-MODAL-FIX] üí™ For√ßage de l\'affichage du modal SMS...');
    
    if (!smsModal) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚ö†Ô∏è Modal SMS non trouv√©');
        return;
    }
    
    // V√©rifier que le modal a bien la classe 'show' avant de forcer l'affichage
    if (!smsModal.classList.contains('show')) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚ö†Ô∏è Modal sans classe show - affichage annul√©');
        return;
    }
    
    // Forcer les styles CSS SEULEMENT si le modal doit √™tre affich√©
    smsModal.style.cssText += `
        z-index: 1070 !important;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
        justify-content: center !important;
        align-items: center !important;
    `;
    
    const modalDialog = smsModal.querySelector('.modal-dialog');
    if (modalDialog) {
        modalDialog.style.cssText += `
            z-index: 1071 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: none !important;
            pointer-events: auto !important;
            width: 500px !important;
            max-width: 90vw !important;
            margin: 1.75rem auto !important;
        `;
    }
    
    const modalContent = smsModal.querySelector('.modal-content');
    if (modalContent) {
        modalContent.style.cssText += `
            z-index: 1072 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            min-width: 400px !important;
            min-height: 300px !important;
            background-color: ${document.body.classList.contains('dark-mode') ? '#2d3748' : '#ffffff'} !important;
            border: 1px solid ${document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'} !important;
            border-radius: 0.375rem !important;
        `;
    }
    
    // Forcer le recalcul du layout
    smsModal.offsetHeight;
    if (modalDialog) modalDialog.offsetHeight;
    if (modalContent) modalContent.offsetHeight;
    
    // V√©rifier les dimensions
    const rect = smsModal.getBoundingClientRect();
    console.log('üîÑ [SMS-MODAL-FIX] üìè Dimensions du modal SMS:', {
        width: rect.width,
        height: rect.height,
        display: getComputedStyle(smsModal).display,
        visibility: getComputedStyle(smsModal).visibility,
        opacity: getComputedStyle(smsModal).opacity,
        zIndex: getComputedStyle(smsModal).zIndex
    });
    
    if (rect.width === 0 || rect.height === 0) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚ö†Ô∏è Modal SMS a des dimensions nulles mais pas de modal de secours automatique');
        
        // D√âSACTIV√â : Le modal de secours automatique causait des probl√®mes
        // setTimeout(function() {
        //     console.log('üîÑ [SMS-MODAL-FIX] üö® √âchec du modal original, cr√©ation du modal de secours...');
        //     window.createEmergencySmsModal();
        // }, 500);
        
    } else {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Modal SMS affich√© avec succ√®s');
    }
}

// Fonction de debug sp√©cifique au modal SMS
window.debugSmsModal = function() {
    const smsModal = document.getElementById('smsModal');
    if (!smsModal) {
        console.log('üîÑ [SMS-MODAL-DEBUG] ‚ùå Modal SMS non trouv√©');
        return;
    }
    
    const modalDialog = smsModal.querySelector('.modal-dialog');
    const modalContent = smsModal.querySelector('.modal-content');
    const rect = smsModal.getBoundingClientRect();
    
    console.log('üîÑ [SMS-MODAL-DEBUG] √âtat du modal SMS:', {
        element: !!smsModal,
        classes: smsModal.className,
        isOpen: smsModal.classList.contains('show'),
        display: getComputedStyle(smsModal).display,
        visibility: getComputedStyle(smsModal).visibility,
        opacity: getComputedStyle(smsModal).opacity,
        zIndex: getComputedStyle(smsModal).zIndex,
        dimensions: {
            width: rect.width,
            height: rect.height
        },
        dialog: {
            element: !!modalDialog,
            display: modalDialog ? getComputedStyle(modalDialog).display : 'N/A',
            dimensions: modalDialog ? modalDialog.getBoundingClientRect() : 'N/A'
        },
        content: {
            element: !!modalContent,
            display: modalContent ? getComputedStyle(modalContent).display : 'N/A',
            dimensions: modalContent ? modalContent.getBoundingClientRect() : 'N/A',
            htmlLength: modalContent ? modalContent.innerHTML.length : 0
        },
        backdrops: document.querySelectorAll('.modal-backdrop').length,
        parent: smsModal.parentElement ? smsModal.parentElement.tagName : 'N/A'
    });
    
    if (modalContent) {
        console.log('üîÑ [SMS-MODAL-DEBUG] Contenu HTML:', modalContent.innerHTML.substring(0, 500));
    }
    
    console.log('üîÑ [SMS-MODAL-DEBUG] üö® Cr√©ation d\'un modal de secours...');
    window.createEmergencySmsModal();
};

// Fonction pour cr√©er un modal SMS de secours
window.createEmergencySmsModal = function() {
    // Supprimer le modal existant s'il existe
    const existingModal = document.getElementById('smsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Cr√©er un nouveau modal SMS fonctionnel
    const emergencyModal = document.createElement('div');
    emergencyModal.id = 'smsModal';
    emergencyModal.className = 'modal fade show';
    emergencyModal.setAttribute('data-emergency-modal', 'true');
    emergencyModal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        z-index: 1070 !important;
        width: 100vw !important;
        height: 100vh !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
    `;
    
    emergencyModal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered" style="
            position: relative !important;
            width: 500px !important;
            max-width: 90vw !important;
            margin: 1.75rem auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: none !important;
        ">
            <div class="modal-content" style="
                position: relative !important;
                width: 100% !important;
                min-width: 400px !important;
                min-height: 300px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
                background-color: ${document.body.classList.contains('dark-mode') ? '#2d3748' : '#ffffff'} !important;
                border: 1px solid ${document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'} !important;
                border-radius: 0.375rem !important;
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
            ">
                <div class="modal-header" style="background-color: ${document.body.classList.contains('dark-mode') ? '#1f2937' : '#f8f9fa'} !important; padding: 15px; border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="margin: 0; color: ${document.body.classList.contains('dark-mode') ? '#f9fafb' : '#333'};">üì± Envoyer un SMS</h5>
                    <button type="button" class="btn-close" onclick="closeEmergencySmsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: ${document.body.classList.contains('dark-mode') ? '#f9fafb' : '#333'};">√ó</button>
                </div>
                 <div class="modal-body" style="padding: 20px; min-height: 200px; color: ${document.body.classList.contains('dark-mode') ? '#f9fafb' : '#333'};">
                     <div class="form-group" style="margin-bottom: 15px;">
                        <label for="emergency-sms-message" style="display: block; margin-bottom: 5px; font-weight: bold;">Message SMS :</label>
                        <textarea id="emergency-sms-message" class="form-control" rows="4" placeholder="Tapez votre message ici..." style="
                            width: 100%; 
                            padding: 10px; 
                            border: 1px solid #ccc; 
                            border-radius: 4px; 
                            resize: vertical;
                            background-color: ${document.body.classList.contains('dark-mode') ? '#374151' : '#ffffff'};
                            color: ${document.body.classList.contains('dark-mode') ? '#f9fafb' : '#333'};
                         "></textarea>
                     </div>
                 </div>
                <div class="modal-footer" style="background-color: ${document.body.classList.contains('dark-mode') ? '#374151' : '#f8f9fa'} !important; padding: 15px; border-top: 1px solid #ddd; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeEmergencySmsModal()" style="
                        padding: 8px 16px; 
                        margin-right: 10px; 
                        background-color: #6c757d; 
                        color: white; 
                        border: none; 
                        border-radius: 4px; 
                        cursor: pointer;
                    ">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="sendEmergencySms()" style="
                        padding: 8px 16px; 
                        background-color: #007bff; 
                        color: white; 
                        border: none; 
                        border-radius: 4px; 
                        cursor: pointer;
                    ">Envoyer SMS</button>
                </div>
            </div>
        </div>
    `;
    
    // Ajouter le modal au body
    document.body.appendChild(emergencyModal);
    
    console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Modal SMS de secours cr√©√© et affich√©');
    return emergencyModal;
};

// Fonction pour envoyer un SMS depuis le modal de secours
window.sendEmergencySms = function() {
    const messageTextarea = document.getElementById('emergency-sms-message');
    const message = messageTextarea ? messageTextarea.value.trim() : '';
    
    if (!message) {
        alert('Veuillez saisir un message SMS');
        return;
    }
    
    // R√©cup√©rer les informations du client depuis le RepairModal qui √©tait ouvert
    const repairId = getActiveRepairId();
    const clientPhone = getClientPhoneFromRepair(repairId);
    const clientId = getClientIdFromRepair(repairId);
    
    // Si pas de t√©l√©phone ET pas de repairId, on ne peut pas envoyer
    if (!clientPhone && !repairId) {
        alert('Impossible de r√©cup√©rer le num√©ro de t√©l√©phone du client et aucun ID de r√©paration disponible');
        return;
    }
    
    console.log('üîÑ [SMS-MODAL-FIX] üì± Envoi SMS de secours:', {
        repairId: repairId,
        phone: clientPhone,
        message: message.substring(0, 50) + '...'
    });
    
    // D√©sactiver le bouton pendant l'envoi
    const sendButton = document.querySelector('#smsModal .btn-primary');
    if (sendButton) {
        sendButton.disabled = true;
        sendButton.textContent = 'Envoi en cours...';
    }
    
    // Pr√©parer les donn√©es (selon l'API send_sms.php)
    const formData = new FormData();
    if (clientPhone) {
        formData.append('telephone', clientPhone);  // Param√®tre correct pour l'API
    }
    formData.append('message', message);
    if (repairId) {
        formData.append('reparation_id', repairId);  // Param√®tre correct pour l'API
    }
    if (clientId) {
        formData.append('client_id', clientId);  // Ajouter client_id si disponible
    }
    
    // Ajouter l'ID du magasin si disponible
    const shopId = getShopId();
    if (shopId) {
        formData.append('shop_id', shopId);
    }
    
    // Envoyer le SMS
    fetch('ajax/send_sms.php', {
        method: 'POST',
        body: formData,
        headers: {
            'Cache-Control': 'no-cache'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('SMS envoy√© avec succ√®s !');
            closeEmergencySmsModal();
        } else {
            alert('Erreur lors de l\'envoi du SMS : ' + (data.message || 'Erreur inconnue'));
        }
    })
    .catch(error => {
        console.error('üîÑ [SMS-MODAL-FIX] ‚ùå Erreur envoi SMS:', error);
        alert('Erreur lors de l\'envoi du SMS : ' + error.message);
    })
    .finally(() => {
        // R√©activer le bouton
        if (sendButton) {
            sendButton.disabled = false;
            sendButton.textContent = 'Envoyer SMS';
        }
    });
};

// Fonction utilitaire pour r√©cup√©rer l'ID de r√©paration active
function getActiveRepairId() {
    // Chercher dans les donn√©es du RepairModal qui √©tait ouvert
    const repairModalElement = document.getElementById('repairDetailsModal');
    if (repairModalElement && repairModalElement.dataset.repairId) {
        return repairModalElement.dataset.repairId;
    }
    
    // Chercher dans l'URL ou d'autres sources
    const urlParams = new URLSearchParams(window.location.search);
    const repairId = urlParams.get('repair_id');
    if (repairId) {
        return repairId;
    }
    
    // Derni√®re tentative : chercher dans les variables globales
    if (typeof window.currentRepairId !== 'undefined') {
        return window.currentRepairId;
    }
    
    return null;
}

// Fonction utilitaire pour r√©cup√©rer le t√©l√©phone du client
function getClientPhoneFromRepair(repairId) {
    console.log('üîÑ [SMS-MODAL-FIX] üìû R√©cup√©ration du t√©l√©phone client pour r√©paration:', repairId);
    
    // 1. Chercher dans les donn√©es globales de la r√©paration
    if (typeof window.repairData !== 'undefined' && window.repairData.client_telephone) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© dans repairData:', window.repairData.client_telephone);
        return window.repairData.client_telephone;
    }
    
    // 2. Chercher dans le bouton SMS qui a d√©clench√© le modal (data-client-tel)
    const smsButton = document.querySelector('.btn-sms[data-client-tel]');
    if (smsButton && smsButton.dataset.clientTel) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© dans bouton SMS:', smsButton.dataset.clientTel);
        return smsButton.dataset.clientTel;
    }
    
    // 3. Chercher dans le DOM du RepairModal - plusieurs s√©lecteurs possibles
    const phoneSelectors = [
        '#repairDetailsModal .client-phone',
        '#repairDetailsModal [data-client-phone]',
        '#repairDetailsModal [data-client-tel]',
        '#repairDetailsModal .client-telephone',
        '#repairDetailsModal .phone',
        '#repairDetailsModal .telephone'
    ];
    
    for (const selector of phoneSelectors) {
        try {
            const phoneElement = document.querySelector(selector);
            if (phoneElement) {
                const phoneText = phoneElement.textContent.trim() || phoneElement.dataset.clientPhone || phoneElement.dataset.clientTel || phoneElement.value;
                if (phoneText && phoneText !== '' && phoneText !== 'N/A' && phoneText !== 'Non renseign√©') {
                    console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© via s√©lecteur', selector, ':', phoneText);
                    return phoneText;
                }
            }
        } catch (e) {
            // Ignorer les erreurs de s√©lecteur
        }
    }
    
    // 4. Chercher dans le texte du modal qui contient "T√©l√©phone :"
    const allElements = document.querySelectorAll('#repairDetailsModal *');
    for (const element of allElements) {
        const text = element.textContent.trim();
        if (text.includes('T√©l√©phone :') || text.includes('T√©l√©phone:')) {
            // Extraire le num√©ro qui suit
            const phoneMatch = text.match(/T√©l√©phone\s*:\s*([0-9\s\+\-\.]+)/);
            if (phoneMatch && phoneMatch[1]) {
                const phone = phoneMatch[1].trim();
                console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© par regex:', phone);
                return phone;
            }
        }
    }
    
    // 5. Chercher dans toutes les cellules qui contiennent un num√©ro de t√©l√©phone
    const allCells = document.querySelectorAll('#repairDetailsModal td, #repairDetailsModal .info-value, #repairDetailsModal .field-value, #repairDetailsModal p');
    for (const cell of allCells) {
        const text = cell.textContent.trim();
        // Regex pour d√©tecter un num√©ro de t√©l√©phone fran√ßais
        const phoneRegex = /^(\+33|0)[1-9](\d{8})$/;
        const cleanText = text.replace(/\s/g, '');
        if (phoneRegex.test(cleanText)) {
            console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© par regex:', text);
            return text;
        }
    }
    
    // 6. Chercher dans les attributs data-* de tous les √©l√©ments
    const elementsWithData = document.querySelectorAll('#repairDetailsModal [data-client-tel], #repairDetailsModal [data-telephone], #repairDetailsModal [data-phone]');
    for (const element of elementsWithData) {
        const phone = element.dataset.clientTel || element.dataset.telephone || element.dataset.phone;
        if (phone && phone !== '' && phone !== 'N/A') {
            console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© dans data attributes:', phone);
            return phone;
        }
    }
    
    // 7. Si on a un repairId, faire un appel AJAX pour r√©cup√©rer les donn√©es
    if (repairId) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚è≥ Tentative de r√©cup√©ration par AJAX pour repairId:', repairId);
        // Cette fonction sera synchrone pour simplifier, mais on pourrait l'am√©liorer
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `ajax/get_repair_details.php?id=${repairId}`, false); // Synchrone
            xhr.send();
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.repair && data.repair.client_telephone) {
                    console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone r√©cup√©r√© par AJAX:', data.repair.client_telephone);
                    return data.repair.client_telephone;
                }
            }
        } catch (e) {
            console.log('üîÑ [SMS-MODAL-FIX] ‚ùå Erreur AJAX:', e.message);
        }
    }
    
    // 8. Derni√®re tentative : chercher dans window.currentRepair si disponible
    if (typeof window.currentRepair !== 'undefined' && window.currentRepair.client_telephone) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ T√©l√©phone trouv√© dans currentRepair:', window.currentRepair.client_telephone);
        return window.currentRepair.client_telephone;
    }
    
    console.log('üîÑ [SMS-MODAL-FIX] ‚ùå Aucun t√©l√©phone trouv√©, impossible d\'envoyer le SMS');
    return null; // Retourner null au lieu d'un num√©ro par d√©faut
}

// Fonction utilitaire pour r√©cup√©rer l'ID du client
function getClientIdFromRepair(repairId) {
    console.log('üîÑ [SMS-MODAL-FIX] üë§ R√©cup√©ration de l\'ID client pour r√©paration:', repairId);
    
    // 1. Chercher dans les donn√©es globales de la r√©paration
    if (typeof window.repairData !== 'undefined' && window.repairData.client_id) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Client ID trouv√© dans repairData:', window.repairData.client_id);
        return window.repairData.client_id;
    }
    
    // 2. Chercher dans le bouton SMS qui a d√©clench√© le modal (data-client-id)
    const smsButton = document.querySelector('.btn-sms[data-client-id]');
    if (smsButton && smsButton.dataset.clientId) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Client ID trouv√© dans bouton SMS:', smsButton.dataset.clientId);
        return smsButton.dataset.clientId;
    }
    
    // 3. Chercher dans les attributs data-* de tous les √©l√©ments du modal
    const elementsWithData = document.querySelectorAll('#repairDetailsModal [data-client-id]');
    for (const element of elementsWithData) {
        const clientId = element.dataset.clientId;
        if (clientId && clientId !== '' && clientId !== '0') {
            console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Client ID trouv√© dans data attributes:', clientId);
            return clientId;
        }
    }
    
    // 4. Chercher dans window.currentRepair si disponible
    if (typeof window.currentRepair !== 'undefined' && window.currentRepair.client_id) {
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Client ID trouv√© dans currentRepair:', window.currentRepair.client_id);
        return window.currentRepair.client_id;
    }
    
    console.log('üîÑ [SMS-MODAL-FIX] ‚ö†Ô∏è Aucun client ID trouv√©');
    return null;
}

// Fonction utilitaire pour r√©cup√©rer l'ID du magasin
function getShopId() {
    // Utiliser la m√™me logique que les autres scripts
    if (typeof window.sessionHelper !== 'undefined' && window.sessionHelper.getShopId) {
        return window.sessionHelper.getShopId();
    }
    
    // Chercher dans les donn√©es de la page
    const shopIdElement = document.querySelector('[data-shop-id]');
    if (shopIdElement) {
        return shopIdElement.dataset.shopId;
    }
    
    // Chercher dans les variables globales
    if (typeof window.shopId !== 'undefined') {
        return window.shopId;
    }
    
    return '63'; // Valeur par d√©faut bas√©e sur les logs
}

// Fonction pour fermer proprement le modal SMS de secours
window.closeEmergencySmsModal = function() {
    console.log('üîÑ [SMS-MODAL-FIX] üö™ Fermeture du modal SMS de secours...');
    
    // Chercher le modal par diff√©rents moyens
    let modal = document.getElementById('smsModal');
    
    if (!modal) {
        // Chercher par classe si l'ID ne fonctionne pas
        modal = document.querySelector('.modal[id*="sms"]');
        console.log('üîÑ [SMS-MODAL-FIX] üîç Modal trouv√© par classe:', modal ? 'Oui' : 'Non');
    }
    
    if (!modal) {
        // Chercher tous les modals visibles
        const visibleModals = document.querySelectorAll('.modal[style*="display: block"], .modal[style*="display:block"]');
        if (visibleModals.length > 0) {
            modal = visibleModals[visibleModals.length - 1]; // Prendre le dernier ouvert
            console.log('üîÑ [SMS-MODAL-FIX] üîç Modal trouv√© parmi les visibles:', modal.id || 'sans ID');
        }
    }
    
    if (modal) {
        console.log('üîÑ [SMS-MODAL-FIX] üìã Modal trouv√© - ID:', modal.id, 'Classes:', modal.className);
        
        // Masquer le modal de toutes les fa√ßons possibles
        modal.style.display = 'none !important';
        modal.style.visibility = 'hidden !important';
        modal.style.opacity = '0 !important';
        modal.style.zIndex = '-1 !important';
        
        // Supprimer les classes Bootstrap si pr√©sentes
        modal.classList.remove('show', 'd-block');
        modal.classList.add('d-none');
        
        // Supprimer compl√®tement le modal s'il a √©t√© cr√©√© dynamiquement
        if (modal.dataset.emergencyModal === 'true') {
            console.log('üîÑ [SMS-MODAL-FIX] üóëÔ∏è Suppression du modal de secours...');
            modal.remove();
        }
        
        console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Modal SMS masqu√©');
    } else {
        console.log('üîÑ [SMS-MODAL-FIX] ‚ùå Aucun modal SMS trouv√©');
        
        // Debug : lister tous les modals pr√©sents
        const allModals = document.querySelectorAll('.modal, [id*="modal"], [id*="Modal"]');
        console.log('üîÑ [SMS-MODAL-FIX] üìã Modals pr√©sents:', Array.from(allModals).map(m => ({
            id: m.id,
            classes: m.className,
            display: m.style.display,
            visible: m.offsetWidth > 0 && m.offsetHeight > 0
        })));
    }
    
    // Nettoyer les backdrops dans tous les cas
    const backdrops = document.querySelectorAll('.modal-backdrop, [class*="backdrop"]');
    console.log('üîÑ [SMS-MODAL-FIX] üßπ Backdrops trouv√©s:', backdrops.length);
    backdrops.forEach((backdrop, index) => {
        console.log(`üîÑ [SMS-MODAL-FIX] üóëÔ∏è Suppression backdrop ${index + 1}:`, backdrop.className);
        backdrop.remove();
    });
    
    // Restaurer le scroll du body dans tous les cas
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Nettoyage termin√©');
};

// Fonction de test pour diagnostiquer les probl√®mes de fermeture
window.testCloseModal = function() {
    console.log('üß™ [SMS-TEST] Test de fermeture du modal...');
    
    // Lister tous les modals
    const allModals = document.querySelectorAll('.modal, [id*="modal"], [id*="Modal"]');
    console.log('üß™ [SMS-TEST] Modals trouv√©s:', allModals.length);
    
    allModals.forEach((modal, index) => {
        console.log(`üß™ [SMS-TEST] Modal ${index + 1}:`, {
            id: modal.id,
            classes: modal.className,
            display: modal.style.display,
            visibility: modal.style.visibility,
            opacity: modal.style.opacity,
            zIndex: modal.style.zIndex,
            visible: modal.offsetWidth > 0 && modal.offsetHeight > 0,
            emergencyModal: modal.dataset.emergencyModal
        });
    });
    
    // Tenter de fermer
    closeEmergencySmsModal();
};

console.log('üîÑ [SMS-MODAL-FIX] ‚úÖ Script pr√™t');
console.log('üîÑ [SMS-MODAL-FIX] üí° Utilisez window.debugSmsModal() pour diagnostiquer');
console.log('üîÑ [SMS-MODAL-FIX] üß™ Utilisez window.testCloseModal() pour tester la fermeture');
